pipeline {
agent {
    label 'vm01'
}
tools {
    nodejs 'NodeJS-18' // Make sure this matches your Jenkins NodeJS installation name
}

environment {
    NODE_ENV = 'test'
    PORT = 3000
    NVD_API_KEY = credentials ('NVD_API_KEY')
    SONAR_SCANNER_HOME = tool 'sonarqube-scanner-7';
}

stages {
    stage('Setup') {
        steps {
            echo 'Ensuring Node.js is available...'
            sh '''
                if ! command -v node >/dev/null; then
                    echo "Node.js not found in PATH!"
                    exit 1
                fi
                echo "Using Node version: $(node -v)"
                '''
        }
    }

    stage('Checkout') {
        steps {
            echo 'Checking out source code...'
            checkout scm
        }
    }
    
    stage('Install Dependencies') {
        steps {
            echo 'Installing Node.js dependencies...'
            sh 'sleep 10s'
            sh 'npm clean-install'
        }
    }
    
stage('Dependency Scanning') {
    steps {
        echo 'Dependency scanning...'
        sh 'mkdir -p dependency-check-reports'

        withCredentials([string(credentialsId: 'NVD_API_KEY', variable: 'NVD_KEY')]) {
            sh """
                ./dependency-check/bin/dependency-check.sh \
                --project MyProject \
                --scan . \
                --out dependency-check-reports \
                --format ALL \
                --prettyPrint \
                --failOnCVSS 7 \
                --nvdApiKey $NVD_KEY \
                --nvdApiDelay 4000 \
                --cveValidForHours 24
            """
        }
    }
    
    } 
    
    stage('Unit Testing') {
        options { retry(2) }
        steps {
            echo 'Running tests...'
            sh 'npm test'
        }
        post {
            always {
                // Archive test results if you generate them
                echo 'Test stage completed'
                junit allowEmptyResults: true, stdioRetention: '', testResults: 'test-results.xml'
            }
        }
    }
    
    stage('Code Quality') {
        parallel {
            stage('Lint') {
                steps {
                    echo 'Running linting...'
                    sh 'npm run lint || echo "Linting not configured, skipping..."'
                }
            }
            stage('Security Audit') {
                steps {
                    echo 'Running security audit...'
                    sh 'npm audit --audit-level=critical || echo "Security audit completed with warnings"'
                }
            }
        }
    }
    
    stage('SAST - SonarQube') {
        steps {
            sh 'echo $SONAR_SCANNER_HOME'
            sh '''
                $SONAR_SCANNER_HOME/bin/sonar-scanner \
                  -Dsonar.host.url=http://192.168.2.206:9000 \
                  -Dsonar.token=sqp_fabd16be54526ef3c3be68c2a67186ceff4fa5ba \
                  -Dsonar.projectKey=hello-world-nodejs
            '''
        }
    }
    
    stage('Build') {
        steps {
            echo 'Building application...'
            sh 'npm run build || echo "No build script found, skipping..."'
        }
    }
    
    stage('Start Application') {
        steps {
            echo 'Starting application for testing...'
            script {
                // Start the application in background
                sh 'npm start &'
                sh 'sleep 10' // Wait for app to start
                
                // Test if application is running
                sh 'curl -f http://localhost:3000/ || exit 1'
                sh 'curl -f http://localhost:3000/api/health || exit 1'
                
                echo 'Application tests passed!'
            }
        }
        post {
            always {
                script {
                    // Stop the application
                    sh 'pkill -f "node server.js" || true'
                    sh 'sleep 2'
                }
            }
        }
    }
}

post {
    always {
        echo 'Cleaning up...'
        sh 'pkill -f "node server.js" || true'
    }
    success {
        echo 'Pipeline completed successfully! ✅'
    }
    failure {
        echo 'Pipeline failed! ❌'
    }
    cleanup {
        // Clean workspace
        cleanWs()
    }
}
}